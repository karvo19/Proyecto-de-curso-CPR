%%%%%%%%%%%%%%% Modelo Dinámico %%%%%%%%%%%%%%%
function [qdd] = ModeloDinamico_R3GDL(in)

% Variables de entrada en la funcion:
q1        = in(1);
q2        = in(2);
q3        = in(3);
qd1       = in(4);
qd2       = in(5);
qd3       = in(6);
Im1      = in(7);
Im2      = in(8);
Im3      = in(9);


% Parámetros base estimados:
t_red=[
    % Reductoras
%    -1.7594
%    -0.3966
%     8.3284
%    16.0353
%     0.3977
%     0.0072
%     0.0120
%     0.0085
%     0.0150
%     2.9131
%     0.9710

% Accionamiento directo (Parametros con medidas perfectas)
         -1.75940038424998
        -0.396642654749998
          2.16551925299997
          1.77669585024997
         0.397667654749993
       0.00722506600000024
        0.0119999999999998
       0.00849999999999985
        0.0149999999999998
          2.91314677499997
         0.971048924999985
];

% Datos geométricos / gravedad / reductoras / constantes de par
l0 = 1.00;
l1 = 0.40;
l2 = 0.70;
l3 = 0.50;

g = 9.81;

R1 = 1;
R2 = 1;
R3 = 1;

% R1 = 50;
% R2 = 30;
% R3 = 15;

R = diag([R1 R2 R3]);

Kt1 = 0.5;
Kt2 = 0.4;
Kt3 = 0.35;
Kt = diag([Kt1 Kt2 Kt3]);

Im=[Im1 Im2 Im3]';

% Modelo en forma matricial (M, V, G)
Ma = [
[ (30612509037519171*cos(2*q2 + q3))/22517998136852480 + (7923634914903717*cos(2*q2))/4503599627370496 + (7145278848525341*cos(2*q2 + 2*q3))/18014398509481984 + (30612509037519171*cos(q3))/22517998136852480 + 39181235098854191/18014398509481984,                                                                                  0,                                                                                   0];
[                                                                                                                                                                                                                                                  0, (30612509037519171*cos(q3))/9007199254740992 + 97924626708858385/18014398509481984, (30612509037519171*cos(q3))/18014398509481984 + 17909359017493675/18014398509481984];
[                                                                                                                                                                                                                                                  0,  (4373215576788453*cos(q3))/2251799813685248 + 17909359017493675/15762598695796736,                                             1167023812028605325/1008806316530991104]];
 
Va = [
                    -(qd1*(3961817457451858500*qd2*sin(2*q2) + 893159856065667625*qd2*sin(2*q2 + 2*q3) + 893159856065667625*qd3*sin(2*q2 + 2*q3) + 1530625451875958550*qd3*sin(q3) + 3061250903751917100*qd2*sin(2*q2 + q3) + 1530625451875958550*qd3*sin(2*q2 + q3) - 27021597764222976))/1125899906842624000;
 (17*qd2)/800 - (30612509037519171*qd3^2*sin(q3))/18014398509481984 + (30612509037519171*qd1^2*sin(2*q2 + q3))/18014398509481984 + (39618174574518585*qd1^2*sin(2*q2))/18014398509481984 + (35726394242626705*qd1^2*sin(2*q2 + 2*q3))/72057594037927936 - (30612509037519171*qd2*qd3*sin(q3))/9007199254740992;
                                                                  (3*qd3)/70 + (4373215576788453*qd1^2*sin(q3))/4503599627370496 + (4373215576788453*qd2^2*sin(q3))/2251799813685248 + (4373215576788453*qd1^2*sin(2*q2 + q3))/4503599627370496 + (35726394242626705*qd1^2*sin(2*q2 + 2*q3))/63050394783186944];
 
Ga = [
                                                                                                    0;
 g*((21866077883942265*cos(q2 + q3))/9007199254740992 + (16399558412956785*cos(q2))/2251799813685248);
                                                  (21866077883942265*g*cos(q2 + q3))/7881299347898368];
 
qdd = inv(Ma)*(Im-Va-Ga);